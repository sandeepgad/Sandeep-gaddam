name: RICH LINUX (GNOME FIXED) - FINAL

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 360

    steps:
      - name: Install Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O /tmp/cloudflared
          chmod +x /tmp/cloudflared
          sudo mv /tmp/cloudflared /usr/local/bin/cloudflared

      - name: Smart GNOME Install
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            gnome-session gnome-shell gnome-terminal nautilus \
            dbus-x11 x11-xserver-utils xorg xrdp \
            adwaita-icon-theme-full fonts-cantarell
          
          # ðŸ›‘ CRITICAL FIX: Disable Color Management Popup that causes black screen
          sudo bash -c "cat > /etc/polkit-1/localauthority/50-local.d/45-allow-colord.pkla" <<EOF
          [Allow Colord]
          Identity=unix-user:*
          Action=org.freedesktop.color-manager.create-device;org.freedesktop.color-manager.create-profile;org.freedesktop.color-manager.delete-device;org.freedesktop.color-manager.delete-profile;org.freedesktop.color-manager.modify-device;org.freedesktop.color-manager.modify-profile
          ResultAny=no
          ResultInactive=no
          ResultActive=yes
          EOF

      - name: Configure XRDP & User
        run: |
          sudo useradd -m -s /bin/bash runner || true
          echo "runner:Antigravity2026!" | sudo chpasswd
          sudo usermod -aG sudo runner
          
          # Fix XRDP session for GNOME
          echo "export GNOME_SHELL_SESSION_MODE=ubuntu" > /home/runner/.xsessionrc
          echo "export XDG_CURRENT_DESKTOP=ubuntu:GNOME" >> /home/runner/.xsessionrc
          echo "export XDG_SESSION_TYPE=x11" >> /home/runner/.xsessionrc
          echo "exec dbus-launch --exit-with-session gnome-session" > /home/runner/.xsession
          
          sudo chown runner:runner /home/runner/.xsession /home/runner/.xsessionrc
          sudo adduser xrdp ssl-cert
          sudo systemctl restart xrdp

      - name: Install VS Code & Chrome
        run: |
          wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > packages.microsoft.gpg
          sudo install -D -o root -g root -m 644 packages.microsoft.gpg /etc/apt/keyrings/packages.microsoft.gpg
          echo "deb [arch=amd64,arm64,armhf signed-by=/etc/apt/keyrings/packages.microsoft.gpg] https://packages.microsoft.com/repos/code stable main" | sudo tee /etc/apt/sources.list.d/vscode.list > /dev/null
          sudo apt-get update && sudo apt-get install -y code
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt install -y ./google-chrome-stable_current_amd64.deb

      - name: Start Tunnel
        run: |
          /usr/local/bin/cloudflared tunnel --url tcp://localhost:3389 > tunnel.log 2>&1 &
          sleep 10
          TUN=$(grep -Eo 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' tunnel.log | head -1)
          echo "ðŸŒ URL: $TUN"
          echo "$TUN" > tunnel_url.txt

      - name: Show Info
        run: |
          TUN=$(cat tunnel_url.txt)
          echo "==================================================="
          echo "Command: cloudflared access tcp --hostname ${TUN#https://} --url localhost:3389"
          echo "User   : runner"
          echo "Pass   : Antigravity2026!"
          echo "==================================================="

      - name: Keep Alive
        run: sleep 21600
